From e5f3dcfd61cc7b02ec62cd91f99a63669dc26222 Mon Sep 17 00:00:00 2001
From: halfmaster1 <ohpointfive@gmail.com>
Date: Mon, 20 Jun 2022 21:31:21 -0400
Subject: [PATCH] Improve hit detection logging


diff --git a/src/main/java/net/minecraft/server/EntityHuman.java b/src/main/java/net/minecraft/server/EntityHuman.java
index d0a8bd8b..5b7fe4ca 100644
--- a/src/main/java/net/minecraft/server/EntityHuman.java
+++ b/src/main/java/net/minecraft/server/EntityHuman.java
@@ -798,17 +798,16 @@ public abstract class EntityHuman extends EntityLiving {
     }
 
     public boolean damageEntity(DamageSource damagesource, float f) {
-        System.out.println("[hd]    Starting damageEntity in EntityHuman");
         if (this.isInvulnerable(damagesource)) {
-            System.out.println("[hd]    Cancelled in EntityHuman duel to invulnerability");
+            System.out.println("[hd] " + (damagesource.getEntity() == null ? "null" : damagesource.getEntity().getName()) + "/" + getName() + " cancelled! EH Invulnerable.");
             return false;
         } else if (this.abilities.isInvulnerable && !damagesource.ignoresInvulnerability()) {
-            System.out.println("[hd]    Cancelled in EntityHuman duel to invulnerability 2");
+            System.out.println("[hd] " + (damagesource.getEntity() == null ? "null" : damagesource.getEntity().getName()) + "/" + getName() + " cancelled! EH Invulnerable 2.");
             return false;
         } else {
             this.ticksFarFromPlayer = 0;
             if (this.getHealth() <= 0.0F) {
-                System.out.println("[hd]    Cancelled in EntityHuman duel to low health");
+                System.out.println("[hd] " + (damagesource.getEntity() == null ? "null" : damagesource.getEntity().getName()) + "/" + getName() + " cancelled! EH Low health.");
                 return false;
             } else {
                 if (this.isSleeping() && !this.world.isClientSide) {
@@ -817,7 +816,7 @@ public abstract class EntityHuman extends EntityLiving {
 
                 if (damagesource.r()) {
                     if (this.world.getDifficulty() == EnumDifficulty.PEACEFUL) {
-                        System.out.println("[hd]    Cancelled in EntityHuman duel to peaceful");
+                        System.out.println("[hd] " + (damagesource.getEntity() == null ? "null" : damagesource.getEntity().getName()) + "/" + getName() + " cancelled! EH Peaceful.");
                         return false; // CraftBukkit - f = 0.0f -> return false
                     }
 
@@ -831,7 +830,7 @@ public abstract class EntityHuman extends EntityLiving {
                 }
 
                 if (false && f == 0.0F) { // CraftBukkit - Don't filter out 0 damage
-                    System.out.println("[hd]    Cancelled due to false???");
+                    System.out.println("[hd] " + (damagesource.getEntity() == null ? "null" : damagesource.getEntity().getName()) + "/" + getName() + " cancelled! EH False???");
                     return false;
                 } else {
                     Entity entity = damagesource.getEntity();
@@ -840,7 +839,6 @@ public abstract class EntityHuman extends EntityLiving {
                         entity = ((EntityArrow) entity).shooter;
                     }
 
-                    System.out.println("[hd]   Going back to super from .damageEntity() in EntityHuman");
                     return super.damageEntity(damagesource, f);
                 }
             }
@@ -1001,7 +999,6 @@ public abstract class EntityHuman extends EntityLiving {
     }
 
     public void attack(Entity entity) {
-        System.out.println("[hd]    Continuing attack in super");
         if (entity.aD()) {
             if (!entity.l(this)) {
                 float f = (float) this.getAttributeInstance(GenericAttributes.ATTACK_DAMAGE).getValue();
@@ -1046,7 +1043,6 @@ public abstract class EntityHuman extends EntityLiving {
                     double d0 = entity.motX;
                     double d1 = entity.motY;
                     double d2 = entity.motZ;
-                    System.out.println("[hd]    Damaging now");
                     boolean flag2 = entity.damageEntity(DamageSource.playerAttack(this), f);
 
                     if (flag2) {
@@ -1064,7 +1060,6 @@ public abstract class EntityHuman extends EntityLiving {
                         }
 
                         if (entity instanceof EntityPlayer && entity.velocityChanged) {
-                            System.out.println("[hd]    Starting KB");
                             // CraftBukkit start - Add Velocity Event
                             boolean cancelled = false;
                             Player player = (Player) entity.getBukkitEntity();
@@ -1074,10 +1069,10 @@ public abstract class EntityHuman extends EntityLiving {
                             world.getServer().getPluginManager().callEvent(event);
 
                             if (event.isCancelled()) {
-                                System.out.println("[hd]    KB cancelled");
+                                System.out.println("[hd] " + this.getName() + "/" + entity.getName() + " cancelled! EH Knockback cancelled by plugin");
                                 cancelled = true;
                             } else if (!velocity.equals(event.getVelocity())) {
-                                System.out.println("[hd]    KB applied");
+                                System.out.println("[hd] !" + this.getName() + "/" + entity.getName() + " succeeded! EH knockback applied!");
                                 player.setVelocity(event.getVelocity());
                             }
 
@@ -1144,20 +1139,19 @@ public abstract class EntityHuman extends EntityLiving {
 
                         this.applyExhaustion(world.spigotConfig.combatExhaustion); // Spigot - Change to use configurable value
                     } else if (flag1) {
-                        System.out.println("[hd]    Extinguishing?");
                         entity.extinguish();
                     } else {
-                        System.out.println("[hd]    Damage failed, no knockback");
+                        System.out.println("[hd] " + this.getName() + "/" + entity.getName() + " cancelled! EH damage failed no KB");
                     }
                 } else {
-                    System.out.println("[hd]    Not enough damage to count");
+                    System.out.println("[hd] " + this.getName() + "/" + entity.getName() + " cancelled! EH not enough damage");
                 }
 
             } else {
-                System.out.println("[hd]    Failed l(this)");
+                System.out.println("[hd] " + this.getName() + "/" + entity.getName() + " cancelled! EH failed l");
             }
         } else {
-            System.out.println("[hd]    Failed aD()");
+            System.out.println("[hd] " + this.getName() + "/" + entity.getName() + " cancelled! EH failed aD");
         }
     }
 
diff --git a/src/main/java/net/minecraft/server/EntityLiving.java b/src/main/java/net/minecraft/server/EntityLiving.java
index f161bd6c..f7cfaef1 100644
--- a/src/main/java/net/minecraft/server/EntityLiving.java
+++ b/src/main/java/net/minecraft/server/EntityLiving.java
@@ -747,20 +747,19 @@ public abstract class EntityLiving extends Entity {
     }
 
     public boolean damageEntity(DamageSource damagesource, float f) {
-        System.out.println("[hd]    Starting in damageEntity in EntityLiving");
         if (this.isInvulnerable(damagesource)) {
-            System.out.println("[hd]    Rejected due to invulnerability");
+            System.out.println("[hd] " + (damagesource.getEntity() == null ? "null" : damagesource.getEntity().getName()) + "/" + getName() + " cancelled! EL invulnerable.");
             return false;
         } else if (this.world.isClientSide) {
-            System.out.println("[hd]    Rejected due to client side world");
+            System.out.println("[hd] " + (damagesource.getEntity() == null ? "null" : damagesource.getEntity().getName()) + "/" + getName() + " cancelled! EL client side.");
             return false;
         } else {
             this.ticksFarFromPlayer = 0;
             if (this.getHealth() <= 0.0F) {
-                System.out.println("[hd]    Rejected due to dead opponent");
+                System.out.println("[hd] " + (damagesource.getEntity() == null ? "null" : damagesource.getEntity().getName()) + "/" + getName() + " cancelled! EL low health.");
                 return false;
             } else if (damagesource.o() && this.hasEffect(MobEffectList.FIRE_RESISTANCE)) {
-                System.out.println("[hd]    Rejected due to fire resistance");
+                System.out.println("[hd] " + (damagesource.getEntity() == null ? "null" : damagesource.getEntity().getName()) + "/" + getName() + " cancelled! EL fire resistance.");
                 return false;
             } else {
                 // CraftBukkit - Moved into d(DamageSource, float)
@@ -775,13 +774,13 @@ public abstract class EntityLiving extends Entity {
                 if ((float) this.noDamageTicks > (float) this.maxNoDamageTicks / 2.0F) {
                     if (f <= this.lastDamage) {
                         this.forceExplosionKnockback = true; // CraftBukkit - SPIGOT-949 - for vanilla consistency, cooldown does not prevent explosion knockback
-                        System.out.println("[hd]    Rejected due damage tick");
+                        System.out.println("[hd] " + (damagesource.getEntity() == null ? "null" : damagesource.getEntity().getName()) + "/" + getName() + " cancelled! EL damage tick.");
                         return false;
                     }
 
                     // CraftBukkit start
                     if (!this.d(damagesource, f - this.lastDamage)) {
-                        System.out.println("[hd]    Reduced (?) and rejected due to damage tick");
+                        System.out.println("[hd] " + (damagesource.getEntity() == null ? "null" : damagesource.getEntity().getName()) + "/" + getName() + " cancelled! EL damage tick 2.");
                         return false;
                     }
                     // CraftBukkit end
@@ -791,7 +790,7 @@ public abstract class EntityLiving extends Entity {
                     // CraftBukkit start
                     float previousHealth = this.getHealth();
                     if (!this.d(damagesource, f)) {
-                        System.out.println("[hd]    Rejected by .d()");
+                        System.out.println("[hd] " + (damagesource.getEntity() == null ? "null" : damagesource.getEntity().getName()) + "/" + getName() + " cancelled! EL rejected by .d().");
                         return false;
                     }
                     this.lastDamage = f;
@@ -848,17 +847,15 @@ public abstract class EntityLiving extends Entity {
                             d0 = (Math.random() - Math.random()) * 0.01D;
                         }
 
-                        System.out.println("[hd]    Applying knockback I think");
                         this.aw = (float) (MathHelper.b(d1, d0) * 180.0D / 3.1415927410125732D - (double) this.yaw);
                         damagesource.knockbackEventCalled = this.a(entity, f, d0, d1); // SportPaper
                     } else {
-                        System.out.println("[hd]    Applying knockback from a null entity");
                         this.aw = (float) ((int) (Math.random() * 2.0D) * 180);
                     }
                 }
 
                 if (knockbackCancelled) {
-                    System.out.println("[hd]    Knockback was cancelled");
+                    System.out.println("[hd] " + (damagesource.getEntity() == null ? "null" : damagesource.getEntity().getName()) + "/" + getName() + " cancelled! EL explosion knockback prevented");
                     this.world.broadcastEntityEffect(this, (byte) 2); // PaperSpigot
                 }
 
@@ -870,7 +867,6 @@ public abstract class EntityLiving extends Entity {
                         this.makeSound(s, this.bB(), this.bC());
                     }
 
-                    System.out.println("[hd]    Killed on hit");
                     this.die(damagesource);
                 } else {
                     s = this.bo();
@@ -879,7 +875,7 @@ public abstract class EntityLiving extends Entity {
                     }
                 }
 
-                System.out.println("[hd]    Hit successful");
+                System.out.println("[hd] !" + (damagesource.getEntity() == null ? "null" : damagesource.getEntity().getName()) + "/" + getName() + " succeeded! EL return true");
                 return true;
             }
         }
@@ -1195,7 +1191,7 @@ public abstract class EntityLiving extends Entity {
 
             EntityDamageEvent event = CraftEventFactory.handleLivingEntityDamageEvent(this, damagesource, originalDamage, hardHatModifier, blockingModifier, armorModifier, resistanceModifier, magicModifier, absorptionModifier, hardHat, blocking, armor, resistance, magic, absorption);
             if (event.isCancelled()) {
-                System.out.println("[hd]    .d() in EntityLiving got a cancelled event");
+                System.out.println("[hd] " + (damagesource.getEntity() == null ? "null" : damagesource.getEntity().getName()) + "/" + getName() + " cancelled! EL by plugin");
                 return false;
             }
 
@@ -1238,10 +1234,9 @@ public abstract class EntityLiving extends Entity {
                 // CraftBukkit end
                 this.setAbsorptionHearts(this.getAbsorptionHearts() - f);
             }
-            System.out.println("[hd]    Successfully got out of .d() in EntityLiving");
             return true; // CraftBukkit
         }
-        System.out.println("[hd]    Cancelled due to invulnerability .d() in EntityLiving");
+        System.out.println("[hd] " + (damagesource.getEntity() == null ? "null" : damagesource.getEntity().getName()) + "/" + getName() + " cancelled! EL explosion knockback prevented");
         return false; // CraftBukkit
     }
 
diff --git a/src/main/java/net/minecraft/server/EntityPlayer.java b/src/main/java/net/minecraft/server/EntityPlayer.java
index 1b8e96d0..4a8962db 100644
--- a/src/main/java/net/minecraft/server/EntityPlayer.java
+++ b/src/main/java/net/minecraft/server/EntityPlayer.java
@@ -1101,12 +1101,9 @@ public class EntityPlayer extends EntityHuman implements ICrafting {
     }
 
     public void attack(Entity entity) {
-        System.out.println("[hd]=== Starting attack ===");
         if (this.playerInteractManager.getGameMode() == WorldSettings.EnumGamemode.SPECTATOR) {
-            System.out.println("[hd]    Was a spectator thing");
             this.setSpectatorTarget(entity);
         } else {
-            System.out.println("[hd]    Continuing attack");
             super.attack(entity);
         }
 
diff --git a/src/main/java/net/minecraft/server/PlayerConnection.java b/src/main/java/net/minecraft/server/PlayerConnection.java
index 091ded22..d547e4f8 100644
--- a/src/main/java/net/minecraft/server/PlayerConnection.java
+++ b/src/main/java/net/minecraft/server/PlayerConnection.java
@@ -1449,18 +1449,18 @@ public class PlayerConnection implements PacketListenerPlayIn, IUpdatePlayerList
     }
 
     public void a(PacketPlayInUseEntity packetplayinuseentity) {
-        System.out.println("[hd]=== Got a packet from " + this.player.getName() + " ===");
-        if (this.player.dead) {
-            System.out.println("[hd]    Rejected packet from dead player");
-            return; // CraftBukkit
-        }
         PlayerConnectionUtils.ensureMainThread(packetplayinuseentity, this, this.player.u());
         WorldServer worldserver = this.minecraftServer.getWorldServer(this.player.dimension);
         Entity entity = packetplayinuseentity.a((World) worldserver);
+        System.out.println("[hd] >>>" + this.player.getName() + "/" + (entity == null ? "null" : entity.getName()) + " packet received!");
+        if (this.player.dead) {
+            System.out.println("[hd] " + this.player.getName() + "/" + (entity == null ? "null" : entity.getName()) + " cancelled! PC dead player.");
+            return; // CraftBukkit
+        }
         // Spigot Start
         if ( entity == player && !player.isSpectator() )
         {
-            System.out.println("[hd]    Stop hitting yourself");
+            System.out.println("[hd] " + this.player.getName() + "/" + (entity == null ? "null" : entity.getName()) + " cancelled! PC hitting self.");
             disconnect( "Cannot interact with self!" );
             return;
         }
@@ -1525,9 +1525,7 @@ public class PlayerConnection implements PacketListenerPlayIn, IUpdatePlayerList
                     }
                     // CraftBukkit end
                 } else if (packetplayinuseentity.a() == PacketPlayInUseEntity.EnumEntityUseAction.ATTACK) {
-                    System.out.println("[hd]    It was an attack!");
                     if (entity instanceof EntityItem || entity instanceof EntityExperienceOrb || entity instanceof EntityArrow || (entity == this.player && !player.isSpectator())) { // CraftBukkit
-                        System.out.println("[hd]    Blocked for invalid entity");
                         this.disconnect("Attempting to attack an invalid entity");
                         this.minecraftServer.warning("Player " + this.player.getName() + " tried to attack an invalid entity");
                         return;
@@ -1537,7 +1535,7 @@ public class PlayerConnection implements PacketListenerPlayIn, IUpdatePlayerList
                     PlayerAttackEntityEvent event = new PlayerAttackEntityEvent(this.getPlayer(), entity.getBukkitEntity());
                     this.server.getPluginManager().callEvent(event);
                     if(event.isCancelled()) {
-                        System.out.println("[hd]    Cancelled by a plugin!");
+                        System.out.println("[hd] " + this.player.getName() + "/" + (entity == null ? "null" : entity.getName()) + " cancelled! PC plugin cancelled.");
                         return;
                     }
                     // CraftBukkit end
@@ -1551,12 +1549,12 @@ public class PlayerConnection implements PacketListenerPlayIn, IUpdatePlayerList
                     // CraftBukkit end
                 }
             } else {
-                System.out.println("[hd]    Hit was too far, so it was cancelled");
+                System.out.println("[hd] " + this.player.getName() + "/" + (entity == null ? "null" : entity.getName()) + " cancelled! PC too far.");
             }
         }
         // Paper start - fire event
         else {
-            System.out.println("[hd]    Hit nothing?");
+            System.out.println("[hd] " + this.player.getName() + "/" + (entity == null ? "null" : entity.getName()) + " cancelled! PC nothing?");
             new org.github.paperspigot.event.player.PlayerUseUnknownEntityEvent(this.getPlayer(), packetplayinuseentity.getEntityId(), packetplayinuseentity.a() == PacketPlayInUseEntity.EnumEntityUseAction.ATTACK).callEvent();
         }
         // Paper end
@@ -2096,7 +2094,7 @@ public class PlayerConnection implements PacketListenerPlayIn, IUpdatePlayerList
                 this.player.ping = i;
             } else {
                 if (i * 100 / this.player.ping > 130) {
-                    System.out.println(this.player.displayName + " ping spiked from " + this.player.ping + "ms to " + i + "ms");
+                    System.out.println(this.player.getName() + " ping spiked from " + this.player.ping + "ms to " + i + "ms");
                 }
                 this.player.ping = (this.player.ping * 3 + i) / 4;
             }
-- 
2.29.2

