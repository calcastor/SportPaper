From 63ee2e2b2c5cbd14fdaf21220f09f837addcc2c2 Mon Sep 17 00:00:00 2001
From: halfmaster1 <ohpointfive@gmail.com>
Date: Sun, 10 Apr 2022 12:49:15 -0400
Subject: [PATCH] Add more water related events


diff --git a/src/main/java/net/minecraft/server/BlockFlowing.java b/src/main/java/net/minecraft/server/BlockFlowing.java
index 2c91d6d5..87531753 100644
--- a/src/main/java/net/minecraft/server/BlockFlowing.java
+++ b/src/main/java/net/minecraft/server/BlockFlowing.java
@@ -7,6 +7,7 @@ import java.util.Set;
 
 // CraftBukkit start
 import org.bukkit.block.BlockFace;
+import org.bukkit.event.block.BlockFormEvent;
 import org.bukkit.event.block.BlockFromToEvent;
 // CraftBukkit end
 
@@ -67,10 +68,17 @@ public class BlockFlowing extends BlockFluids {
             if (this.a >= 2 && this.material == Material.WATER) {
                 IBlockData iblockdata1 = world.getType(blockposition.down());
 
-                if (iblockdata1.getBlock().getMaterial().isBuildable()) {
-                    i1 = 0;
-                } else if (iblockdata1.getBlock().getMaterial() == this.material && ((Integer) iblockdata1.get(BlockFlowing.LEVEL)).intValue() == 0) {
-                    i1 = 0;
+                if (iblockdata1.getBlock().getMaterial().isBuildable() || (iblockdata1.getBlock().getMaterial() == this.material && ((Integer) iblockdata1.get(BlockFlowing.LEVEL)).intValue() == 0)) {
+
+                    org.bukkit.block.BlockState blockState = world.getWorld().getBlockAt(blockposition.getX(), blockposition.getY(), blockposition.getZ()).getState();
+                    blockState.getMaterialData().setData((byte) 0);
+
+                    BlockFormEvent waterSourceFormEvent = new BlockFormEvent(blockState.getBlock(), blockState);
+                    world.getServer().getPluginManager().callEvent(waterSourceFormEvent);
+                    if (!waterSourceFormEvent.isCancelled()) {
+                        i1 = 0;
+                    }
+
                 }
             }
 
diff --git a/src/main/java/net/minecraft/server/BlockIce.java b/src/main/java/net/minecraft/server/BlockIce.java
index be8bb5be..36fa5d1b 100644
--- a/src/main/java/net/minecraft/server/BlockIce.java
+++ b/src/main/java/net/minecraft/server/BlockIce.java
@@ -2,6 +2,9 @@ package net.minecraft.server;
 
 import java.util.Random;
 
+import org.bukkit.block.BlockState;
+import org.bukkit.event.block.BlockFormEvent;
+
 public class BlockIce extends BlockHalfTransparent {
 
     public BlockIce() {
@@ -49,7 +52,20 @@ public class BlockIce extends BlockHalfTransparent {
                 return;
             }
             // CraftBukkit end
-            
+
+            BlockState blockState = world.getWorld().getBlockAt(blockposition.getX(), blockposition.getY(), blockposition.getZ()).getState();
+            if (world.worldProvider.n()) {
+                blockState.setTypeId(Block.getId(Blocks.AIR));
+            } else {
+                blockState.setTypeId(Block.getId(Blocks.FLOWING_WATER));
+            }
+
+            BlockFormEvent iceBlockForm = new BlockFormEvent(blockState.getBlock(), blockState);
+            world.getServer().getPluginManager().callEvent(iceBlockForm);
+            if (iceBlockForm.isCancelled()) {
+                return;
+            }
+
             if (world.worldProvider.n()) {
                 world.setAir(blockposition);
             } else {
-- 
2.29.2

